<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Shipping Quote</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gray-25: #FCFCFD;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D2D6DB;
            --gray-400: #9DA4AE;
            --gray-500: #6C737F;
            --gray-600: #4D5761;
            --gray-700: #384250;
            --gray-800: #1F2A37;
            --gray-900: #111927;
            --primary-25: #FAFAFF;
            --primary-50: #F4F3FF;
            --primary-100: #EBE9FE;
            --primary-200: #D9D6FE;
            --primary-300: #BDB4FE;
            --primary-400: #9B8AFB;
            --primary-500: #7A5AF8;
            --primary-600: #6941C6;
            --primary-700: #5925DC;
            --primary-800: #4A1FB8;
            --primary-900: #3E1C96;
            --success-50: #ECFDF3;
            --success-100: #D1FADF;
            --success-500: #12B76A;
            --success-600: #039855;
            --success-700: #027A48;
            --error-50: #FEF3F2;
            --error-500: #F04438;
            --error-600: #D92D20;
            --error-700: #B42318;
            --warning-50: #FFFAEB;
            --warning-500: #F79009;
            --warning-600: #DC6803;
            --shadow-xs: 0px 1px 2px rgba(16, 24, 40, 0.05);
            --shadow-sm: 0px 1px 3px rgba(16, 24, 40, 0.1), 0px 1px 2px rgba(16, 24, 40, 0.06);
            --shadow-md: 0px 4px 8px -2px rgba(16, 24, 40, 0.1), 0px 2px 4px -2px rgba(16, 24, 40, 0.06);
            --shadow-lg: 0px 12px 16px -4px rgba(16, 24, 40, 0.08), 0px 4px 6px -2px rgba(16, 24, 40, 0.03);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            min-height: 100vh;
            padding: 32px 16px;
            color: var(--gray-900);
            line-height: 1.5;
        }
        .container { max-width: 560px; margin: 0 auto; }
        h1 { font-size: 30px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px; }
        .subtitle { color: var(--gray-500); font-size: 16px; margin-bottom: 32px; }
        .package-info {
            background: var(--primary-50);
            border: 1px solid var(--primary-200);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
        }
        .package-info .label {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-700);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .package-info .details { color: var(--gray-700); font-size: 14px; line-height: 1.7; }
        .package-info .details strong { color: var(--gray-900); font-weight: 600; }
        .card {
            background: #FFFFFF;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-200);
        }
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 6px; }
        input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            background: #FFFFFF;
            color: var(--gray-900);
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        input:focus { outline: none; border-color: var(--primary-500); box-shadow: 0 0 0 4px var(--primary-100); }
        input::placeholder { color: var(--gray-400); }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .row-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; }
        .btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
        }
        .btn-primary { background: var(--primary-600); color: #FFFFFF; box-shadow: var(--shadow-xs); }
        .btn-primary:hover { background: var(--primary-700); }
        .btn-primary:active { background: var(--primary-800); }
        .btn-primary:disabled { background: var(--gray-300); cursor: not-allowed; }
        .btn-success { background: var(--success-600); color: #FFFFFF; box-shadow: var(--shadow-xs); }
        .btn-success:hover { background: var(--success-700); }
        .btn-success:disabled { background: var(--gray-300); cursor: not-allowed; }
        .btn-secondary { background: #FFFFFF; color: var(--gray-700); border: 1px solid var(--gray-300); }
        .btn-secondary:hover { background: var(--gray-50); }
        .error-message {
            background: var(--error-50);
            border: 1px solid var(--error-500);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 16px;
            color: var(--error-700);
            font-size: 14px;
            display: none;
        }
        .rates-section { margin-top: 24px; display: none; }
        .rates-section.show { display: block; }
        .rates-title { font-size: 16px; font-weight: 600; color: var(--gray-900); margin-bottom: 16px; }
        .rate-card {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
        }
        .rate-card:hover { border-color: var(--primary-300); box-shadow: var(--shadow-sm); }
        .rate-card.selected { border-color: var(--primary-600); background: var(--primary-50); }
        .rate-card .radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .rate-card.selected .radio { border-color: var(--primary-600); }
        .rate-card.selected .radio::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--primary-600);
            border-radius: 50%;
        }
        .rate-left { display: flex; align-items: center; }
        .rate-info h4 { font-size: 14px; font-weight: 600; color: var(--gray-900); margin-bottom: 4px; }
        .rate-info p { font-size: 13px; color: var(--gray-500); }
        .rate-price { font-size: 20px; font-weight: 700; color: var(--success-600); }
        .no-rates {
            background: var(--warning-50);
            border: 1px solid var(--warning-500);
            border-radius: 8px;
            padding: 16px;
            color: var(--warning-600);
            font-size: 14px;
            text-align: center;
        }
        .confirm-btn { margin-top: 16px; display: none; }
        .confirm-btn.show { display: block; }

        /* Confirmation Screen */
        .confirmation-screen { display: none; }
        .confirmation-screen.show { display: block; }
        .success-icon {
            width: 64px;
            height: 64px;
            background: var(--success-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        .success-icon svg { width: 32px; height: 32px; color: var(--success-600); }
        .confirmation-title { font-size: 24px; font-weight: 600; text-align: center; margin-bottom: 8px; }
        .confirmation-subtitle { color: var(--gray-500); text-align: center; margin-bottom: 24px; }
        .order-summary {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }
        .order-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .order-row:last-child { margin-bottom: 0; padding-top: 12px; border-top: 1px solid var(--gray-200); font-weight: 600; }
        .order-label { color: var(--gray-600); }
        .order-value { color: var(--gray-900); font-weight: 500; }
        .payment-info {
            background: var(--primary-50);
            border: 1px solid var(--primary-200);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 24px;
        }
        .payment-info h3 { color: var(--primary-700); font-size: 16px; margin-bottom: 12px; }
        .payment-info .zelle-info { font-size: 18px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px; }
        .payment-info p { color: var(--gray-600); font-size: 14px; }
        .tracking-info {
            background: var(--success-50);
            border: 1px solid var(--success-500);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            color: var(--success-700);
            font-size: 14px;
        }
        .tracking-info strong { display: block; margin-bottom: 4px; }
        .hidden { display: none !important; }

        /* Processing overlay */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .processing-overlay.hidden { display: none; }
        .processing-content { text-align: center; }
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 480px) {
            .row-3 { grid-template-columns: 1fr; }
            .row-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Processing Overlay -->
        <div id="processingOverlay" class="processing-overlay hidden">
            <div class="processing-content">
                <div class="spinner"></div>
                <p style="color: var(--gray-700); font-weight: 500;">Processing your order...</p>
            </div>
        </div>

        <!-- Step 1: Address Form -->
        <div id="step1">
            <h1>Shipping Quote</h1>
            <p class="subtitle">Enter your address to get shipping rates</p>

            <div class="package-info">
                <div class="label">Package Details</div>
                <div class="details" id="packageDetails">Loading...</div>
            </div>

            <div class="card">
                <h2 class="section-title">Your Address</h2>
                <form id="addressForm">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label for="street">Street Address</label>
                        <input type="text" id="street" placeholder="123 Main St" required>
                    </div>
                    <div class="form-group">
                        <label for="street2">Apt/Suite (Optional)</label>
                        <input type="text" id="street2" placeholder="Apt 4B">
                    </div>
                    <div class="row-3">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" placeholder="New York" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" id="state" placeholder="NY" maxlength="2" style="text-transform: uppercase;" required>
                        </div>
                        <div class="form-group">
                            <label for="zip">ZIP Code</label>
                            <input type="text" id="zip" placeholder="10001" required>
                        </div>
                    </div>
                    <div class="row-2">
                        <div class="form-group">
                            <label for="phone">Phone Number (Optional)</label>
                            <input type="tel" id="phone" placeholder="(555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label for="email">Email (Optional)</label>
                            <input type="email" id="email" placeholder="john@example.com">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Get Shipping Rates</button>
                </form>

                <div class="error-message" id="errorSection"></div>

                <div class="rates-section" id="ratesSection">
                    <h3 class="rates-title">Select a Shipping Option</h3>
                    <div id="ratesList"></div>
                    <button class="btn btn-success confirm-btn" id="confirmBtn" onclick="confirmAndPurchase()">Confirm & Place Order</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Confirmation Screen -->
        <div id="step2" class="confirmation-screen">
            <div class="card">
                <div class="success-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h2 class="confirmation-title">Order Confirmed!</h2>
                <p class="confirmation-subtitle" id="confirmSubtitle">Your shipping label has been created</p>

                <div class="order-summary">
                    <div class="order-row">
                        <span class="order-label">Shipping Method</span>
                        <span class="order-value" id="summaryMethod">-</span>
                    </div>
                    <div class="order-row">
                        <span class="order-label">Estimated Delivery</span>
                        <span class="order-value" id="summaryDelivery">-</span>
                    </div>
                    <div class="order-row">
                        <span class="order-label">Total</span>
                        <span class="order-value" id="summaryTotal">-</span>
                    </div>
                </div>

                <div class="tracking-info" id="trackingInfo">
                    <strong id="trackingTitle">Tracking Number</strong>
                    <div id="trackingNumbers"></div>
                </div>

                <div class="payment-info" style="margin-top: 24px;">
                    <h3>Pay with Zelle</h3>
                    <div class="zelle-info">609-608-2654</div>
                    <p>Please include your name in the Zelle memo.<br>Your item will be shipped once payment is received.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API URL - Change this to your deployed API server URL
        // For local development: '' (empty string uses same origin)
        // For production: 'https://el-wafaa-shipping.onrender.com' or similar
        const API_URL = 'https://el-wafaa-shipping.onrender.com';

        let packageData = null;
        let addressData = null;
        let selectedRate = null;
        let allRates = [];

        const urlParams = new URLSearchParams(window.location.search);
        const pkgParam = urlParams.get('pkg');

        // Check if this order was already completed (server-side)
        async function checkExistingOrder() {
            if (!pkgParam) return null;
            try {
                const response = await fetch(API_URL + '/api/order/' + encodeURIComponent(pkgParam));
                const data = await response.json();
                if (data.exists) {
                    return data.order;
                }
            } catch (e) {
                console.error('Error checking existing order:', e);
            }
            return null;
        }

        function showCompletedOrder(order) {
            document.getElementById('summaryMethod').textContent = order.method;
            document.getElementById('summaryDelivery').textContent = order.delivery;
            document.getElementById('summaryTotal').textContent = order.total;

            // Handle multiple tracking numbers
            const trackingNumbers = order.labels || [{ tracking_number: order.tracking_number }];
            if (trackingNumbers.length > 1) {
                document.getElementById('trackingTitle').textContent = 'Tracking Numbers';
                document.getElementById('confirmSubtitle').textContent = `Your ${trackingNumbers.length} shipping labels have been created`;
            }
            document.getElementById('trackingNumbers').innerHTML = trackingNumbers.map((l, i) =>
                trackingNumbers.length > 1
                    ? `<div style="margin: 4px 0;">Package ${i + 1}: ${l.tracking_number}</div>`
                    : `<span>${l.tracking_number}</span>`
            ).join('');

            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('show');
        }

        // Check for existing order on page load
        async function initPage() {
            const existingOrder = await checkExistingOrder();
            if (existingOrder) {
                showCompletedOrder(existingOrder);
            }
        }
        initPage();

        if (pkgParam) {
            try {
                packageData = JSON.parse(atob(decodeURIComponent(pkgParam)));
                const packages = Array.isArray(packageData) ? packageData : [packageData];
                let html = '';
                packages.forEach((pkg, i) => {
                    html += `<strong>Package ${i + 1}:</strong> ${pkg.description}<br>`;
                    html += `Dimensions: ${pkg.length}" x ${pkg.width}" x ${pkg.height}" | Weight: ${pkg.weight} lbs`;
                    if (i < packages.length - 1) html += '<br><br>';
                });
                document.getElementById('packageDetails').innerHTML = html;
            } catch (e) {
                document.getElementById('packageDetails').textContent = 'Error loading package details';
            }
        } else {
            document.getElementById('packageDetails').textContent = 'No package information provided';
        }

        document.getElementById('addressForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Getting Rates...';

            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('ratesSection').classList.remove('show');
            document.getElementById('confirmBtn').classList.remove('show');
            selectedRate = null;

            addressData = {
                name: document.getElementById('name').value,
                street: document.getElementById('street').value,
                street2: document.getElementById('street2').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value.toUpperCase(),
                zip: document.getElementById('zip').value,
                phone: document.getElementById('phone').value || '848-292-6767',
                email: document.getElementById('email').value || ''
            };

            try {
                const response = await fetch(API_URL + '/api/rates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        packages: Array.isArray(packageData) ? packageData : [packageData],
                        destination: addressData
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get rates');
                }

                allRates = data.rates;
                displayRates(data.rates);
            } catch (error) {
                document.getElementById('errorSection').textContent = error.message;
                document.getElementById('errorSection').style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Get Shipping Rates';
            }
        });

        function displayRates(rates) {
            const ratesList = document.getElementById('ratesList');
            ratesList.innerHTML = '';

            if (!rates || rates.length === 0) {
                ratesList.innerHTML = '<div class="no-rates">No shipping rates available for this destination.</div>';
                document.getElementById('ratesSection').classList.add('show');
                return;
            }

            rates.sort((a, b) => parseFloat(a.amount) - parseFloat(b.amount));

            rates.forEach((rate, index) => {
                const card = document.createElement('div');
                card.className = 'rate-card';
                card.dataset.index = index;
                card.onclick = () => selectRate(index);
                card.innerHTML = `
                    <div class="rate-left">
                        <div class="radio"></div>
                        <div class="rate-info">
                            <h4>${rate.provider} - ${rate.servicelevel.name}</h4>
                            <p>Estimated ${rate.estimated_days || 'N/A'} business days</p>
                        </div>
                    </div>
                    <div class="rate-price">$${parseFloat(rate.amount).toFixed(2)}</div>
                `;
                ratesList.appendChild(card);
            });

            document.getElementById('ratesSection').classList.add('show');
        }

        function selectRate(index) {
            document.querySelectorAll('.rate-card').forEach(card => card.classList.remove('selected'));
            document.querySelector(`.rate-card[data-index="${index}"]`).classList.add('selected');
            selectedRate = allRates[index];
            document.getElementById('confirmBtn').classList.add('show');
        }

        async function confirmAndPurchase() {
            if (!selectedRate) return;

            const btn = document.getElementById('confirmBtn');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            // Show processing overlay
            document.getElementById('processingOverlay').classList.remove('hidden');

            try {
                const response = await fetch(API_URL + '/api/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        package_rates: selectedRate.package_rates,
                        packages: Array.isArray(packageData) ? packageData : [packageData],
                        destination: addressData,
                        pkgId: pkgParam,
                        selectedRate: {
                            provider: selectedRate.provider,
                            servicelevel: selectedRate.servicelevel,
                            estimated_days: selectedRate.estimated_days,
                            amount: selectedRate.amount
                        }
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create labels');
                }

                // Show confirmation with order data
                const orderData = {
                    method: `${selectedRate.provider} - ${selectedRate.servicelevel.name}`,
                    delivery: `${selectedRate.estimated_days || 'N/A'} business days`,
                    total: `$${parseFloat(selectedRate.amount).toFixed(2)}`,
                    labels: data.labels,
                    completed_at: new Date().toISOString()
                };
                showCompletedOrder(orderData);

                document.getElementById('processingOverlay').classList.add('hidden');

            } catch (error) {
                document.getElementById('processingOverlay').classList.add('hidden');
                document.getElementById('errorSection').textContent = error.message;
                document.getElementById('errorSection').style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Confirm & Place Order';
            }
        }
    </script>
</body>
</html>
